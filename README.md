# com.halo9k/ring-oidc-session [![Build Status](https://github.com/intronic/ring-oidc-session/actions/workflows/test.yml/badge.svg)](https://github.com/intronic/ring-oidc-session/actions/workflows/test.yml)

[Ring][] middleware that adds OIDC session handling.
Based on and to be used together with  [ring-oauth2][].

* Adds an app route for the OIDC `end_session` endpoint which also clears the ring `:session` key.
    * Optionally provides for a separate OIDC callback route.
* Adds an app route that clears the ring `:session` key but leaves the OIDC session intact.

[ring]: https://github.com/ring-clojure/ring
[oauth 2.0]: https://oauth.net/2/
[ring-oauth2]: https://github.com/weavejester/ring-oauth2

## Usage

The middleware function to use is `ring-oidc-session/wrap-oidc-session`.
This takes a Ring handler, and a map of profiles as arguments. Each
profile has a key to identify it, and a map of options that define how
to authorize against a third-party service.

This adds some keys to the map in the [ring-oauth2][] example.

Here's an example for your OIDC IdP that provides the `end_session` endpoint:

```clojure
(require '[ring-oidc-session :refer [wrap-oidc-session]])

(def handler
  (wrap-oidc-session
   routes
   {:your-oidc-provider
    {:end-session-uri    "{oidc_idp_domain}/oidc/v1/end_session"
     :logout-oidc-uri      "/your/end-session/route"
     :post-logout-oidc-uri "/your/end-session/callback"
     :logout-ring-uri      "/your/logout/route"
     :post-logout-uri      "/your-logged-out-dest"
    }}))
```

Keys:

* `:end-session-uri`
    * The OIDC IdP `end-session` endpoint
* `:logout-oidc-uri`
    * logout of app and end OIDC session
    * redirects to `:post-logout-oidc-uri` (or `:post-logout-uri`, see below)
* `:post-logout-oidc-uri`
    * optional oidc end-session callback
    * if not present, defaults to `:post-logout-uri`
* `:logout-ring-uri`
    * logout of app (ring session), leaving oidc session intact
    * redirects to `:post-logout-uri`
* `:post-logout-uri`
    * optional final redirect
    * if not present, defaults to `:landing-uri` (from the `wrap-oauth2` profile map), otherwise defaults to `/`


### Middleware Order

This should be placed above the `wrap-oauth2` handler, where `oidc-profile-map` in the merged profile map of oauth2 and oidc-session data above:

```clojure
   ...middleware...
   (wrap-oidc-session oidc-profile-map)
   (wrap-oauth2 oidc-profile-map)
   ...middleware...
```


## Notes

Invoke a library API function from the command-line:

    $ clojure -X com.halo9k.ring-oidc-session/foo :a 1 :b '"two"'
    {:a 1, :b "two"} "Hello, World!"

Run the project's tests (they'll fail until you edit them):

    $ clojure -T:build test

Run the project's CI pipeline and build a JAR (this will fail until you edit the tests to pass):

    $ clojure -T:build ci

This will produce an updated `pom.xml` file with synchronized dependencies inside the `META-INF`
directory inside `target/classes` and the JAR in `target`. You can update the version (and SCM tag)
information in generated `pom.xml` by updating `build.clj`.

Install it locally (requires the `ci` task be run first):

    $ clojure -T:build install

Deploy it to Clojars -- needs `CLOJARS_USERNAME` and `CLOJARS_PASSWORD` environment
variables (requires the `ci` task be run first):

    $ clojure -T:build deploy

Your library will be deployed to com.halo9k/ring-oidc-session on clojars.org by default.

### Test coverage

* See [test-coverage][]

* Run tests and produce fully annotatated source coverage report in `target/coverage/`:

```bash
clj -M:test:coverage
firefox target/coverage/index.html
```

[test-coverage]: https://github.com/cloverage/cloverage

## License

Copyright Â© 2024 Mike

_EPLv1.0 is just the default for projects generated by `deps-new`: you are not_
_required to open source this project, nor are you required to use EPLv1.0!_
_Feel free to remove or change the `LICENSE` file and remove or update this_
_section of the `README.md` file!_

Distributed under the Eclipse Public License version 1.0.
